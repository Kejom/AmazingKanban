@inject IBoardService BoardService
@inject IUsersService UserService
@inject IUserUtility UserUtility

<div style="width:30em">
    <div class="border p-3" style="width:90%;margin:auto">
        <EditForm Model="newBoard.Board" OnValidSubmit="CreateBoard">
            <DataAnnotationsValidator></DataAnnotationsValidator>

            <div class="form-group" style="margin:5px">
                <div style="display:flex; justify-content:center"><label for="name" class="required">Board Name</label></div>
                <InputText id="name" @bind-Value="newBoard.Board.Name" class="form-control"></InputText>
                <ValidationMessage For="@(() => newBoard.Board.Name)" />
            </div>
            <div class="form-group" style="margin:5px">
                <div style="display:flex; justify-content:center"><label for="name" class="required" style="text-align:center">Board Description</label></div>
                <InputTextArea id="description" @bind-Value="newBoard.Board.Description" class="form-control" style="height:20em"></InputTextArea>
                <ValidationMessage For="@(() => newBoard.Board.Description)" />
            </div>
            <div class="form-group" style="margin:5px">
                <div style="display:flex; justify-content:center"><label for="users" style="text-align:center">User Access</label></div>
                <BlazoredTypeahead SearchMethod="@TypeAhead"
                                   @bind-Value="@SelectedUser"
                                   placeholder="Search for user.."
                                   Debounce="500">
                    <SelectedTemplate Context="selectedContext">
                        @selectedContext.User.Email
                    </SelectedTemplate>
                    <ResultTemplate Context="resultContext">
                        @resultContext.User.Email
                    </ResultTemplate>
                    <NotFoundTemplate Context="notFoundContext">
                        No users found
                    </NotFoundTemplate>
                </BlazoredTypeahead>
                <hr />
                <table class="table table-bordered table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th width="40%">
                                User Email
                            </th>
                            <th width="40%">
                                Access Level
                            </th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!String.IsNullOrEmpty(SelectedUser.User.Email))
                        {
                            <tr>
                                <td>@SelectedUser.User.Email</td>
                                <td>
                                    <InputSelect @bind-Value="SelectedUser.BoardRole">
                                        @foreach (var role in Enum.GetValues(typeof(BoardRoles)))
                                        {
                                        if((BoardRoles)role == BoardRoles.NoAccess)
                                                continue;

                                        <option value="@role">@role</option>
                                        }
                                </InputSelect>
                            </td>
                            <td>
                                <div class="w-75 btn-group" role="group">
                                    <button class="btn btn-success" @onclick="AddUserToList"><span class="oi oi-plus"></span></button>
                                </div>
                            </td>
                        </tr>
                        }
                        @if (SelectedUsers.Count > 0)
                        {
                            @foreach (var user in SelectedUsers)
                            {
                                <tr>
                                    <td>@user.User.Email</td>
                                    <td>
                                        <InputSelect @bind-Value="user.BoardRole">
                                            @foreach (var role in Enum.GetValues(typeof(BoardRoles)))
                                            {
                                        <option value="@role">@role</option>
                                            }
                                </InputSelect>
                            </td>
                            <td>
                                <div class="w-75 btn-group" role="group">
                                    <button class="btn btn-danger" @onclick="()=> SelectedUsers.Remove(user)"><span class="oi oi-delete"></span></button>
                                </div>
                            </td>
                        </tr>
                            }
                        }
                    </tbody>
                </table>

            </div>
            <div style="display:flex; justify-content:center; margin:5px"><button type="submit" class="btn btn-primary">Create</button></div>
        </EditForm>
    </div>
</div>

@code {
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    BoardSubmitVM newBoard = new BoardSubmitVM();
    BoardUserVM SelectedUser = new BoardUserVM();
    List<BoardUserVM> SelectedUsers = new List<BoardUserVM>();

    async Task CreateBoard()
    {
        AddSelectedUsersToNewBoard();
        await BoardService.AddBoard(newBoard);
        await ModalInstance.CloseAsync();
    }

    async Task<IEnumerable<BoardUserVM>> TypeAhead(string filter)
    {
        var users = await UserService.GetUsers(filter);
        var usersVM = users.Select(u => new BoardUserVM
            {
                User = u,
                BoardRole = BoardRoles.User

            });
        var currentUserId = await UserUtility.GetCurrentUserId();
        Console.WriteLine($"current user ID: {currentUserId}");
        return usersVM.Where(u => !SelectedUsers.Exists(s => s.User.Id == u.User.Id) && u.User.Id != currentUserId).ToList();
    }
    void AddUserToList()
    {
        SelectedUser.BoardRole = BoardRoles.User;
        SelectedUsers.Add(SelectedUser);
        SelectedUser = new BoardUserVM();
    }

    void AddSelectedUsersToNewBoard()
    {
        foreach(var user in SelectedUsers)
        {
            newBoard.UserAccesses.Add(
                new BoardAccess<UserLite>
                    {
                        UserId = user.User.Id,
                        Role = user.BoardRole.Value
                    }
            );
        }
    }
}
